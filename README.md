# О проекте
Тестовое задание на реализацию класса Apple (Yii2 Advanced + Docker).

## Изменения по сравнению с заданием:
- Так как яблоко откусывается в %, то и целостность яблока указывается в %. Единообразие используемых величин.
- Период гниения яблока для удобства проверки изменён с 5 часов на 5 минут.
- Можно указать % съедения больше оставшегося, ошибки не будет и яблоко будет скушано целиком (по аналогии с погодой: съедена четверть, но ощущается как половина).

## Детали реализации:
- **Архитектура:** Используется паттерн "Толстая модель, тонкий контроллер". Вся бизнес-логика инкапсулирована в моделях `Apple` и `User`.
- **Оптимизация:** Яблоки в таблице базы генерируются за 1 SQL запрос (batchInsert), предварительно очищая старые записи пользователя.
- **Состояние:** Проверка на гниение яблока выполняется "на лету" (Lazy evaluation) при запросе списка или попытке взаимодействия, что исключает необходимость фоновых скриптов (cron).
- **Интерфейс:** Backend-приложение генерирует дерево и яблоки. Реализована визуализация на JS/jQuery.
- **Frontend-логика:** На клиент передаются только допустимые действия (`actions`) для каждого яблока. Координаты яблок фиксируются в `localStorage` браузера, чтобы избежать "прыжков" при обновлении данных.
- **Безопасность:** Доступ к функционалу только для авторизованных пользователей.

---

## Инструкция по развертыванию на облачном хостинге (VPS)

Для запуска проекта не требуется платный Managed Database сервис. База данных работает в контейнере.

### 1. Требования к серверу
- Любой VPS (Ubuntu 20.04/22.04 или Debian).
- Установленные `git`, `docker` и `docker-compose`.

### 2. Установка
Клонируйте репозиторий на сервер:
```bash
git clone <ссылка_на_ващ_репозиторий>
cd <папка_проекта>
```

### 3. Настройка сохранения данных (Важно!)
Чтобы при перезапуске контейнеров данные в БД не удалялись, откройте `docker-compose.yml` и добавьте (раскомментируйте) секцию `volumes` для сервиса `mysql`:

```yaml
  mysql:
    image: mysql:5.7
    # ...
    volumes:
       - ./mysql_data:/var/lib/mysql  # <-- Добавить эту строку
```

### 4. Запуск контейнеров
Соберите и запустите проект в фоновом режиме:
```bash
docker-compose up -d --build
```

### 5. Инициализация приложения
Выполните следующие команды внутри контейнера `backend` для настройки фреймворка:

1. **Установка зависимостей:**
   ```bash
   docker-compose exec backend composer install
   ```

2. **Инициализация Yii2:**
   ```bash
   docker-compose exec backend php init
   ```
   *Выберите `0` (Development) для простоты настройки или `1` (Production).*

3. **Настройка подключения к БД:**
   Файл конфига сбросится после init. Нужно прописать хост базы данных (`mysql` вместо `localhost`).

   Откройте файл `common/config/main-local.php` (можно через nano на сервере или отредактировать локально и залить):
   ```php
   'dsn' => 'mysql:host=mysql;dbname=yii2advanced', // Важно: host=mysql
   'username' => 'yii2advanced',
   'password' => 'secret', // Как в docker-compose.yml
   ```

4. **Применение миграций:**
   ```bash
   docker-compose exec backend php yii migrate
   ```
   *(Согласитесь `yes` на создание таблиц и тестовых пользователей `po1`/`po2`)*.

### 6. Доступ к приложению
Проект будет доступен по портам, указанным в `docker-compose.yml`:

- **Backend (Сад):** `http://<IP-СЕРВЕРА>:21081`
- **Frontend:** `http://<IP-СЕРВЕРА>:20081`

**Данные для входа:**
- Логин: `po1` Пароль: `po1`
- Логин: `po2` Пароль: `po2`